# Namespace settings
namespace:
  create: true
  name: sms-app

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

config:
  appHostPort: "8080"
  appServerPort: ""
  modelHost: ""
  modelServicePort: ""
  modelUrl: "https://github.com/doda2025-team17/model-service/releases/download/v1.0.0/model-artifacts.tar.gz"
  dashboardVersion: "v1"

grafana:
  host: grafana.local

app:
  replicaCount: 2
  versionLabel: v1  # Version label for stable deployment
  
  # Canary deployment settings
  canary:
    enabled: false  # Set to true for canary deployment
    replicaCount: 1
    versionLabel: v2  # Version label for canary deployment
    image:
      repository: ""  # Defaults to app.image.repository if empty
      tag: ""         # Defaults to app.image.tag if empty
      pullPolicy: ""  # Defaults to app.image.pullPolicy if empty
    podAnnotations: {}
  
  image:
    repository: ghcr.io/doda2025-team17/app
    tag: latest
    pullPolicy: IfNotPresent
  containerPort: 8080
  service:
    type: ClusterIP
    port: 80
    metricsPort: 8080
  resources: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  readinessProbe:
    path: /
    initialDelaySeconds: 5
    periodSeconds: 10
  livenessProbe:
    path: /
    initialDelaySeconds: 15
    periodSeconds: 20

# Model Service Configuration
modelService:
  replicaCount: 1
  versionLabel: v1  # Version label for stable deployment
  
  # Canary deployment settings
  canary:
    enabled: false  # Set to true for canary deployment
    replicaCount: 1
    versionLabel: v2  # Version label for canary deployment
    image:
      repository: ""  # Defaults to modelService.image.repository if empty
      tag: ""         # Defaults to modelService.image.tag if empty
      pullPolicy: ""  # Defaults to modelService.image.pullPolicy if empty
  
  image:
    repository: ghcr.io/doda2025-team17/model-service
    tag: latest
    pullPolicy: IfNotPresent
  containerPort: 8081
  service:
    type: ClusterIP
    port: 8081
  volume:
    enabled: true
    hostPath: /mnt/shared/models
  resources: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  readinessProbe:
    tcpSocket: true
    initialDelaySeconds: 5
    periodSeconds: 10
  livenessProbe:
    tcpSocket: true
    initialDelaySeconds: 15
    periodSeconds: 20
  shadow:
    enabled: false
    replicaCount: 1
    versionLabel: v2
    image:
      repository: ""
      tag: ""
      pullPolicy: ""
    resources: {}
    podAnnotations: {}
    mirror:
      enabled: true
      percent: 10  

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  hosts:
    - host: sms-app.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Istio Traffic Management
istio:
  enabled: false  # Set to true to enable Istio routing
  hosts:
    - sms-app.local
  
  gateway:
    name: sms-app-gateway
    port: 80
    # Configurable selector for IngressGateway
    # Override this for clusters with different IngressGateway labels
    selector:
      istio: ingressgateway
    tls: {}
  
  canary:
    stableSubset: v1
    canarySubset: v2
    weights:
      stable: 90
      canary: 10
    subsetLabelKey: version
    stickyCookie:
      enabled: true
      name: sms-app-version
      ttl: 3600s
  modelRouting:
    subsetLabelKey: version    

# Monitoring / Prometheus setup
monitoring:
  enabled: false
  serviceMonitor:
    labelKey: monitoring
    labelValue: sms-app
    namespace: sms-app
  ports:
    name: metrics
  paths:
    app: /actuator/prometheus
    model: /metrics
  scrapeInterval: 15s

# Alerting
alerting:
  enabled: false
  email:
    to: "team17-alerts@example.com"
    from: "sms-app-alerts@example.com"
    smarthost: "smtp.gmail.com:587"
    username: "your-sender@gmail.com"
    # PASSWORD IS NOT STORED HERE - it comes from pre-deployed 'smtp-credentials' Secret

# kube-prometheus-stack subchart configuration
kube-prometheus-stack:
  enabled: true

  prometheusOperator:
    image:
      registry: quay.io
      repository: prometheus-operator/prometheus-operator
      tag: v0.68.0

  alertmanager:
    enabled: false
    # Use AlertmanagerConfig CRDs for routing (which support secretKeyRef)
    alertmanagerSpec:
      alertmanagerConfigSelector:
        matchLabels:
          alertmanagerConfig: sms-app
      alertmanagerConfigNamespaceSelector: {}
    # Base config - routes are extended by AlertmanagerConfig CRD
    config:
      global:
        resolve_timeout: 5m
      route:
        receiver: 'null'
        group_by: ['alertname']
      receivers:
        - name: 'null'
      # NO SMTP CREDENTIALS HERE - handled by AlertmanagerConfig CRD

  prometheus:
    prometheusSpec:
      serviceMonitorSelector:
        matchLabels:
          monitoring: sms-app
      serviceMonitorNamespaceSelector: {}
      ruleSelector:
        matchLabels:
          release: sms-app
      ruleNamespaceSelector: {}

  # Enable Grafana
  grafana:
    enabled: false
    
    image:
      repository: grafana/grafana
      tag: "9.5.0"
    adminPassword: admin  # Change in production or use secret
    
    # Auto-provision dashboards from ConfigMaps with label grafana_dashboard=sms-app
    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: sms-app
        searchNamespace: ALL
        folderAnnotation: grafana_folder
        provider:
          foldersFromFilesStructure: true
    
    # Ingress for Grafana
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - grafana.local
      path: /
