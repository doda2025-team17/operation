{{- if .Values.istio.enabled }}
{{- $namespace := default .Release.Namespace .Values.namespace.name -}}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "sms-app.fullname" . }}-model-vs
  namespace: {{ $namespace }}
  labels:
    {{- include "sms-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: istio-virtualservice
spec:
  hosts:
    - {{ include "sms-app.model.name" . }}
    - {{ include "sms-app.model.name" . }}.{{ $namespace }}.svc.cluster.local
  gateways:
    - mesh
  http:
    {{- if .Values.modelService.shadow.enabled }}
    - name: model-stable-with-shadow
      route:
        - destination:
            host: {{ include "sms-app.model.name" . }}
            subset: {{ .Values.modelService.versionLabel | quote }}
      {{- if and .Values.modelService.shadow.mirror.enabled (gt (float64 (default 0 .Values.modelService.shadow.mirror.percent)) 0.0) }}
      mirror:
        host: {{ include "sms-app.model.name" . }}
        subset: {{ .Values.modelService.shadow.versionLabel | quote }}
      mirrorPercentage:
        value: {{ default 0 .Values.modelService.shadow.mirror.percent }}
      {{- end }}

    {{- else if .Values.modelService.canary.enabled }}
    # Paired routing (CE requirement)
    - name: model-for-app-canary
      match:
        - sourceLabels:
            {{ .Values.istio.modelRouting.subsetLabelKey }}: {{ .Values.app.canary.versionLabel | quote }}
      route:
        - destination:
            host: {{ include "sms-app.model.name" . }}
            subset: {{ .Values.modelService.canary.versionLabel | quote }}

    - name: model-default-stable
      route:
        - destination:
            host: {{ include "sms-app.model.name" . }}
            subset: {{ .Values.modelService.versionLabel | quote }}

    {{- else }}
    - name: model-default
      route:
        - destination:
            host: {{ include "sms-app.model.name" . }}
            subset: {{ .Values.modelService.versionLabel | quote }}
    {{- end }}
{{- end }}
