{{- if and .Values.monitoring.enabled (index .Values "kube-prometheus-stack" "grafana" "enabled") }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-shadow-dashboard
  namespace: {{ .Values.namespace.name }}
  labels:
    grafana_dashboard: sms-app
  annotations:
    grafana_folder: "SMS App"
data:
  sms-app-shadow.json: |-
    {
      "title": "Shadow Launch Monitoring (v1 primary -> v2 shadow)",
      "tags": ["sms-app", "shadow", "model"],
      "timezone": "browser",
      "schemaVersion": 38,
      "style": "dark",
      "uid": "sms-app-shadow",
      "version": 3,
      "refresh": "10s",
      "time": { "from": "now-30m", "to": "now" },
      "templating": {
        "list": [
          {
            "name": "datasource",
            "type": "datasource",
            "query": "prometheus",
            "refresh": 1,
            "hide": 0,
            "includeAll": false,
            "current": { "selected": false, "text": "Prometheus", "value": "prometheus" }
          }
        ]
      },
      "panels": [
        {
          "title": "Primary predictions / min (v1, avg over last 5m)",
          "type": "gauge",
          "gridPos": { "h": 8, "w": 6, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": { "defaults": { "unit": "reqpm", "min": 0 } },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [
            {
              "expr": "sum(increase(sms_model_predictions_total{version=\"v1\"}[5m])) / 5",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Shadow predictions / min (v2, avg over last 5m)",
          "type": "gauge",
          "gridPos": { "h": 8, "w": 6, "x": 6, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": { "defaults": { "unit": "reqpm", "min": 0 } },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [
            {
              "expr": "sum(increase(sms_model_predictions_total{version=\"v2\", source=\"shadow\"}[5m])) / 5",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Shadow / Primary ratio (last 5m)",
          "type": "gauge",
          "gridPos": { "h": 8, "w": 6, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": { "defaults": { "unit": "percentunit", "min": 0, "max": 1 } },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [
            {
              "expr": "sum(increase(sms_model_predictions_total{version=\"v2\", source=\"shadow\"}[5m])) / clamp_min(sum(increase(sms_model_predictions_total{version=\"v1\"}[5m])), 1)",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Shadow is receiving traffic (last 5m)",
          "type": "stat",
          "gridPos": { "h": 8, "w": 6, "x": 18, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "mappings": [
                { "type": "value", "options": { "0": { "text": "NO" }, "1": { "text": "YES" } } }
              ]
            }
          },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [
            {
              "expr": "sum(increase(sms_model_predictions_total{version=\"v2\", source=\"shadow\"}[5m])) > 0",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Predictions over time (rate, 5m)",
          "type": "timeseries",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 8 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "fieldConfig": { "defaults": { "unit": "reqps" } },
          "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
          "targets": [
            {
              "expr": "sum(rate(sms_model_predictions_total{version=\"v1\"}[5m]))",
              "legendFormat": "primary(v1)",
              "refId": "A"
            },
            {
              "expr": "sum(rate(sms_model_predictions_total{version=\"v2\", source=\"shadow\"}[5m]))",
              "legendFormat": "shadow(v2)",
              "refId": "B"
            }
          ]
        }
      ]
    }
{{- end }}
