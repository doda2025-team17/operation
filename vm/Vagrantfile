# -*- mode: ruby -*-
# vi: set ft=ruby :

NUM_WORKERS = 2
CTRL_CPU = 1
NODE_CPU = 2
CTRL_MEMORY = "4096"
NODE_MEMORY = "6144"

Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-24.04"

  # Control Node
  config.vm.define "ctrl" do |ctrl|
    ctrl.vm.hostname = "ctrl"
    ctrl.vm.network "private_network", ip: "192.168.56.100"
    
    ctrl.vm.provider "virtualbox" do |vb|
      vb.name = "k8s-ctrl"
      vb.memory = CTRL_MEMORY
      vb.cpus = CTRL_CPU
    end
  end

  # Worker Nodes
  (1..NUM_WORKERS).each do |i|
    config.vm.define "node-#{i}" do |node|
      node.vm.hostname = "node-#{i}"
      node.vm.network "private_network", ip: "192.168.56.#{100 + i}"
      
      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-node-#{i}"
        vb.memory = NODE_MEMORY
        vb.cpus = NODE_CPU
      end
    end
  end

  # One single Ansible provisioner that runs after all VMs are up
  # It should also automatically generate an in-memory inventory.cfg file
  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "ansible/master.yaml"
    ansible.groups = {
      "ctrl" => ["ctrl"],
      "nodes" => (1..NUM_WORKERS).map { |i| "node-#{i}" },
      "k8s_cluster:children" => ["ctrl", "nodes"]
    }
    ansible.extra_vars = {
      num_workers: NUM_WORKERS
    }
  end

  # This makes Vagrant generate a physical inventory.cfg file
  # TODO: clarify whether this is the requirement or if in-memory .cfg is sufficient
  config.trigger.after :provision do |trigger|
    trigger.name = "Generate Ansible Inventory File"
    trigger.info = "Creating inventory.cfg with all cluster nodes"
    
    inventory_content = <<~EOF
[ctrl]
ctrl ansible_host=192.168.56.100 ansible_user=vagrant

[nodes]
#{ (1..NUM_WORKERS).map { |i| "node-#{i} ansible_host=192.168.56.#{100 + i} ansible_user=vagrant" }.join("\n") }

[k8s_cluster:children]
ctrl
nodes

[all:vars]
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
EOF

    File.write("inventory.cfg", inventory_content)
    puts "Generated inventory.cfg with #{NUM_WORKERS} worker nodes"
  end
end