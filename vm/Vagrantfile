# -*- mode: ruby -*-
# vi: set ft=ruby :

NUM_WORKERS = 2
CTRL_CPU = 1
NODE_CPU = 2
CTRL_MEMORY = "4096"
NODE_MEMORY = "6144"

system("VBoxManage dhcpserver remove --network=HostInterfaceNetworking-vboxnet0 2>/dev/null")

Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-24.04"
  
  # Create shared folder on host
  SHARED_DIR = File.expand_path("~/k8s-shared-storage")
  Dir.mkdir(SHARED_DIR) unless Dir.exist?(SHARED_DIR)
  
  # Control Node
  config.vm.define "ctrl" do |ctrl|
    ctrl.vm.hostname = "ctrl"
    ctrl.vm.network "private_network", ip: "192.168.56.100"
    
    # Mount shared folder
    ctrl.vm.synced_folder SHARED_DIR, "/mnt/shared", 
      type: "virtualbox",
      owner: "vagrant",
      group: "vagrant",
      mount_options: ["dmode=775", "fmode=664"]
    
    ctrl.vm.provider "virtualbox" do |vb|
      vb.name = "k8s-ctrl"
      vb.memory = CTRL_MEMORY
      vb.cpus = CTRL_CPU
    end
  end
  
  # Worker Nodes
  (1..NUM_WORKERS).each do |i|
    config.vm.define "node-#{i}" do |node|
      node.vm.hostname = "node-#{i}"
      node.vm.network "private_network", ip: "192.168.56.#{100 + i}"
      
      # Mount same shared folder on workers
      node.vm.synced_folder SHARED_DIR, "/mnt/shared",
        type: "virtualbox",
        owner: "vagrant",
        group: "vagrant",
        mount_options: ["dmode=775", "fmode=664"]
      
      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-node-#{i}"
        vb.memory = NODE_MEMORY
        vb.cpus = NODE_CPU
      end
      
      # Only provision after last node is up
      if i == NUM_WORKERS
        node.vm.provision "ansible" do |ansible|
          ansible.limit = "all"  # Provision all VMs at once
          ansible.playbook = "ansible/master.yaml"
          ansible.groups = {
            "ctrl" => ["ctrl"],
            "nodes" => (1..NUM_WORKERS).map { |j| "node-#{j}" },
            "k8s_cluster:children" => ["ctrl", "nodes"]
          }
          ansible.extra_vars = {
            num_workers: NUM_WORKERS
          }
        end
      end
    end
  end
  
  # Generate inventory.cfg file
  config.trigger.after :provision do |trigger|
    trigger.name = "Generate Ansible Inventory File"
    trigger.info = "Creating inventory.cfg with all cluster nodes"
    
    inventory_content = <<~EOF
[ctrl]
ctrl ansible_host=192.168.56.100 ansible_user=vagrant

[nodes]
#{ (1..NUM_WORKERS).map { |i| "node-#{i} ansible_host=192.168.56.#{100 + i} ansible_user=vagrant" }.join("\n") }

[k8s_cluster:children]
ctrl
nodes

[all:vars]
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
EOF
    
    File.write("inventory.cfg", inventory_content)
    puts "Generated inventory.cfg with #{NUM_WORKERS} worker nodes"
  end
end