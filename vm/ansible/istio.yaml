---
# Step 23: Install Istio (with fixed LB IP via MetalLB)
- name: Install and configure Istio service mesh
  hosts: ctrl
  become: yes
  gather_facts: no

  vars:
    istio_version: "1.25.2"
    istio_gateway_ip: "192.168.56.96"
    istio_root: "/opt/istio-{{ istio_version }}"
    istio_bin: "{{ istio_root }}/bin/istioctl"

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/istio-{{ istio_version }}/bin"

  tasks:
    - name: Detect system architecture
      command: uname -m
      register: arch_result
      changed_when: false

    - name: Set architecture variable
      set_fact:
        istio_arch: "{{ 'arm64' if arch_result.stdout == 'aarch64' else 'amd64' }}"

    - name: Set Istio download URL
      set_fact:
        istio_tgz: "istio-{{ istio_version }}-linux-{{ istio_arch }}.tar.gz"
        istio_url: "https://github.com/istio/istio/releases/download/{{ istio_version }}/istio-{{ istio_version }}-linux-{{ istio_arch }}.tar.gz"

    - name: Download Istio {{ istio_version }}
      get_url:
        url: "{{ istio_url }}"
        dest: "/tmp/{{ istio_tgz }}"
        mode: "0644"

    - name: Check if Istio tarball already exists
      stat:
        path: "/tmp/{{ istio_tgz }}"
      register: istio_tgz_stat

    - name: Download Istio {{ istio_version }}
      get_url:
        url: "{{ istio_url }}"
        dest: "/tmp/{{ istio_tgz }}"
        mode: "0644"
      when: not istio_tgz_stat.stat.exists

    - name: Check if Istio root dir exists
      stat:
        path: "{{ istio_root }}"
      register: istio_root_stat

    - name: Unpack Istio under /opt
      unarchive:
        src: "/tmp/{{ istio_tgz }}"
        dest: "/opt"
        remote_src: yes
      when: not istio_root_stat.stat.exists

    - name: Symlink istioctl into /usr/local/bin
      file:
        src: "{{ istio_bin }}"
        dest: /usr/local/bin/istioctl
        state: link
        force: yes

    - name: Add Istio bin dir to PATH for all users (profile.d)
      copy:
        dest: /etc/profile.d/istio.sh
        mode: "0644"
        content: |
          # added by provisioning (feat-23)
          export PATH=$PATH:{{ istio_root }}/bin

    - name: Render custom IstioOperator manifest (fixed LoadBalancer IP)
      template:
        src: templates/istio-operator.yaml.j2
        dest: /tmp/istio-operator.yaml
        mode: "0644"

    - name: Install or upgrade Istio with fixed ingressgateway IP
      command: istioctl install -y -f /tmp/istio-operator.yaml

    - name: Wait for istiod to be Available (up to 5m)
      command: kubectl -n istio-system rollout status deploy/istiod --timeout=5m
      changed_when: false

    - name: Wait for istio-ingressgateway to be Available (up to 5m)
      command: kubectl -n istio-system rollout status deploy/istio-ingressgateway --timeout=5m
      changed_when: false

    - name: Verify istio-ingressgateway has the expected EXTERNAL-IP
      command: >
        kubectl -n istio-system get svc istio-ingressgateway
        -o jsonpath={.status.loadBalancer.ingress[0].ip}
      register: gw_ip
      changed_when: false

    - name: Assert LoadBalancer IP matches requested value
      assert:
        that:
          - gw_ip.stdout == istio_gateway_ip
        fail_msg: "Istio ingressgateway EXTERNAL-IP ({{ gw_ip.stdout }}) != expected {{ istio_gateway_ip }}"
        success_msg: "Istio ingressgateway EXTERNAL-IP correctly set to {{ istio_gateway_ip }}"
