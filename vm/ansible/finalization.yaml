---
# Steps 20â€“22: MetalLB, Ingress, and Dashboard setup
- name: Install and configure MetalLB, Ingress, and Dashboard
  hosts: ctrl
  become: yes
  gather_facts: no

  vars:
    # MetalLB settings
    metallb_version: "v0.14.9"
    metallb_namespace: "metallb-system"
    metallb_pool_start: "192.168.56.90"
    metallb_pool_end:   "192.168.56.99"
    metallb_wait_timeout: "180s"

    # Step 21 vars
    ingress_namespace: "ingress-nginx"
    ingress_lb_ip: "192.168.56.95"
    ingress_wait_timeout: "240s"

    # Dashboard settings
    kd_ns: kubernetes-dashboard
    kd_release: kubernetes-dashboard
    kd_repo_name: kubernetes-dashboard
    kd_repo_url: https://kubernetes.github.io/dashboard
    ingress_host: dashboard.local
    ingress_class: nginx

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    # Step 20: MetalLB install
    - name: Apply MetalLB operator (native)
      command: >
        kubectl apply -f
        https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml

    - name: Wait for MetalLB controller to be Ready
      command: >
        kubectl wait --namespace {{ metallb_namespace }}
        --for=condition=Ready pod
        -l app=metallb,component=controller
        --timeout={{ metallb_wait_timeout }}
      changed_when: false

    - name: Wait for MetalLB speakers to be Ready
      command: >
        kubectl wait --namespace {{ metallb_namespace }}
        --for=condition=Ready pod
        -l app=metallb,component=speaker
        --timeout={{ metallb_wait_timeout }}
      changed_when: false

    - name: Render MetalLB IPAddressPool + L2Advertisement
      template:
        src: templates/metallb-config.yaml.j2
        dest: /tmp/metallb-config.yaml
        mode: '0644'

    - name: Apply MetalLB address pool configuration
      command: kubectl apply -f /tmp/metallb-config.yaml

    # Step 21: NGINX Ingress
    - name: Add ingress-nginx Helm repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
      register: ingress_repo

    - name: Install/upgrade NGINX Ingress Controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: "{{ ingress_namespace }}"
        create_namespace: true
        timeout: 600s
        values:
          controller:
            service:
              type: LoadBalancer
              externalTrafficPolicy: Local
              loadBalancerIP: "{{ ingress_lb_ip }}"
            ingressClassResource:
              default: true
            ingressClass: nginx

    - name: Wait for ingress controller pod to be Ready
      command: >
        kubectl wait --namespace {{ ingress_namespace }}
        --for=condition=Ready pod
        -l app.kubernetes.io/component=controller
        --timeout={{ ingress_wait_timeout }}
      changed_when: false

    - name: Verify Service has the expected EXTERNAL-IP
      command: >
        kubectl get svc -n {{ ingress_namespace }} ingress-nginx-controller
        -o jsonpath={.status.loadBalancer.ingress[0].ip}
      register: svc_ip
      changed_when: false

    - name: Assert EXTERNAL-IP matches the configured MetalLB IP
      assert:
        that:
          - svc_ip.stdout == ingress_lb_ip
        fail_msg: "Ingress Service EXTERNAL-IP ({{ svc_ip.stdout }}) does not match expected {{ ingress_lb_ip }}"
        success_msg: "Ingress Service EXTERNAL-IP correctly set to {{ ingress_lb_ip }}"

    # Step 22: Install and expose Kubernetes Dashboard
    - name: Add Helm repo for Kubernetes Dashboard
      command: helm repo add {{ kd_repo_name }} {{ kd_repo_url }}
      register: kd_repo_add
      changed_when: "'has been added' in kd_repo_add.stdout or 'updated' in kd_repo_add.stdout or kd_repo_add.rc == 0"

    - name: Helm repo update
      command: helm repo update
      changed_when: false

    - name: Install or upgrade Kubernetes Dashboard chart
      command: >
        helm upgrade --install {{ kd_release }}
        {{ kd_repo_name }}/kubernetes-dashboard
        --namespace {{ kd_ns }} --create-namespace
      register: kd_install
      changed_when: "'deployed' in kd_install.stdout or 'upgraded' in kd_install.stdout"

    # Ensure Python client for Kubernetes is available (required by kubernetes.core.k8s)
    - name: Install python3-kubernetes via apt
      apt:
        name: python3-kubernetes
        state: present
        update_cache: yes

    - name: Create admin ServiceAccount
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: "{{ kd_ns }}"

    - name: Bind admin-user to cluster-admin
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user-binding
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: "{{ kd_ns }}"
          roleRef:
            kind: ClusterRole
            name: cluster-admin
            apiGroup: rbac.authorization.k8s.io

    - name: Apply Dashboard Ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: kubernetes-dashboard
            namespace: "{{ kd_ns }}"
            annotations:
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            ingressClassName: "{{ ingress_class }}"
            rules:
              - host: "{{ ingress_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: kubernetes-dashboard-kong-proxy
                          port:
                            number: 443

    - name: Wait for Dashboard pods to be Ready
      command: >
        kubectl wait -n {{ kd_ns }} --for=condition=Ready pod
        -l "app.kubernetes.io/name=kubernetes-dashboard"
        --timeout=180s
      changed_when: false
      failed_when: false
