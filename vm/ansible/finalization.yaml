---
# Steps 20â€“21: MetalLB + NGINX Ingress
- name: Install and configure MetalLB and Ingress
  hosts: ctrl
  become: yes
  gather_facts: no

  vars:
    # Step 20 vars
    metallb_version: "v0.14.9"
    metallb_namespace: "metallb-system"
    metallb_pool_start: "192.168.56.90"
    metallb_pool_end:   "192.168.56.99"
    metallb_wait_timeout: "180s"

    # Step 21 vars
    ingress_namespace: "ingress-nginx"
    ingress_lb_ip: "192.168.56.95"
    ingress_wait_timeout: "240s"

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    # Step 20: MetalLB install
    - name: Check that nodes are visible
      command: kubectl get nodes
      register: nodes_out
      changed_when: false

    - name: Apply MetalLB operator (native)
      command: >
        kubectl apply -f
        https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml

    - name: Wait for MetalLB controller to be Ready
      command: >
        kubectl wait --namespace {{ metallb_namespace }}
        --for=condition=Ready pod
        -l 'app=metallb,component=controller'
        --timeout={{ metallb_wait_timeout }}
      changed_when: false

    - name: Wait for MetalLB speakers to be Ready
      command: >
        kubectl wait --namespace {{ metallb_namespace }}
        --for=condition=Ready pod
        -l 'app=metallb,component=speaker'
        --timeout={{ metallb_wait_timeout }}
      changed_when: false

    - name: Render MetalLB IPAddressPool + L2Advertisement
      template:
        src: templates/metallb-config.yaml.j2
        dest: /tmp/metallb-config.yaml
        mode: '0644'

    - name: Apply MetalLB address pool configuration
      command: kubectl apply -f /tmp/metallb-config.yaml

    # Step 21: NGINX Ingress (Helm, idempotent)
    - name: Add ingress-nginx Helm repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
      register: ingress_repo

    - name: Install/upgrade NGINX Ingress Controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: "{{ ingress_namespace }}"
        create_namespace: true
        wait: true
        timeout: 600s
        values:
          controller:
            service:
              type: LoadBalancer
              externalTrafficPolicy: Local
              loadBalancerIP: "{{ ingress_lb_ip }}"
            ingressClassResource:
              default: true
            ingressClass: nginx

    - name: Wait for ingress controller pod to be Ready
      command: >
        kubectl wait --namespace {{ ingress_namespace }}
        --for=condition=Ready pod
        -l app.kubernetes.io/component=controller
        --timeout={{ ingress_wait_timeout }}
      changed_when: false

    - name: Verify Service has the expected EXTERNAL-IP
      command: >
        kubectl get svc -n {{ ingress_namespace }} ingress-nginx-controller
        -o jsonpath={.status.loadBalancer.ingress[0].ip}
      register: svc_ip
      changed_when: false

    - name: Assert EXTERNAL-IP matches the configured MetalLB IP
      assert:
        that:
          - svc_ip.stdout == ingress_lb_ip
        fail_msg: "Ingress Service EXTERNAL-IP ({{ svc_ip.stdout }}) does not match expected {{ ingress_lb_ip }}"
        success_msg: "Ingress Service EXTERNAL-IP correctly set to {{ ingress_lb_ip }}"
