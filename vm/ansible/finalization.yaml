---
# Steps 20â€“21: MetalLB + NGINX Ingress
- name: Install and configure MetalLB and Ingress
  hosts: ctrl
  become: yes
  gather_facts: no

  vars:
    # Step 20 vars
    metallb_version: "v0.14.9"
    metallb_namespace: "metallb-system"
    metallb_pool_start: "192.168.56.90"
    metallb_pool_end:   "192.168.56.99"
    metallb_wait_timeout: "180s"

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    # Step 20: MetalLB install
    - name: Check that nodes are visible
      command: kubectl get nodes
      register: nodes_out
      changed_when: false

    - name: Make control-plane schedulable (single-node cluster)
      command: kubectl taint nodes --all node-role.kubernetes.io/control-plane-
      register: untaint1
      failed_when: false
      changed_when: "'taint key' in untaint1.stderr or untaint1.rc == 0"

    - name: Remove legacy master taint if present
      command: kubectl taint nodes --all node-role.kubernetes.io/master-
      register: untaint2
      failed_when: false
      changed_when: "'taint key' in untaint2.stderr or untaint2.rc == 0"

    - name: Apply MetalLB operator (native)
      command: >
        kubectl apply -f
        https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml

    - name: Create MetalLB memberlist secret if missing
      shell: |
        kubectl -n {{ metallb_namespace }} get secret memberlist >/dev/null 2>&1 || \
        kubectl -n {{ metallb_namespace }} create secret generic memberlist \
          --from-literal=secretkey="$(openssl rand -base64 128)"
      changed_when: false

    - name: Wait for MetalLB controller to be Ready (up to 10 minutes)
      command: kubectl wait --namespace metallb-system --for=condition=Ready pod -l component=controller --timeout=600s
      register: metallb_wait
      retries: 3
      delay: 30
      until: metallb_wait.rc == 0

    - name: Wait for MetalLB speaker to be Ready
      command: >
        kubectl wait --namespace {{ metallb_namespace }}
        --for=condition=Ready pod
        -l component=speaker
        --timeout={{ metallb_wait_timeout }}
      changed_when: false

    - name: Render MetalLB IPAddressPool + L2Advertisement
      template:
        src: templates/metallb-config.yaml.j2
        dest: /tmp/metallb-config.yaml
        mode: '0644'

    - name: Apply MetalLB address pool configuration
      command: kubectl apply -f /tmp/metallb-config.yaml
