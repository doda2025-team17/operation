---
# Worker node setup
- name: Join worker nodes to Kubernetes cluster
  hosts: all
  become: yes
  tasks:
    - name: Check if node is already part of cluster
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Wait for join command file to be available
      wait_for:
        path: /vagrant/join-command.sh
        state: present
        timeout: 300
      delegate_to: localhost
      become: no
      when: not kubelet_conf.stat.exists

    - name: Copy join command from shared folder
      copy:
        src: /vagrant/join-command.sh
        dest: /tmp/join-command.sh
        mode: "0755"
      when: not kubelet_conf.stat.exists

    - name: Join the Kubernetes cluster
      command: /tmp/join-command.sh
      when: not kubelet_conf.stat.exists

    - name: Remove join command file
      file:
        path: /tmp/join-command.sh
        state: absent
